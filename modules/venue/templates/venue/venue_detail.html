{% extends "base.html" %}
{% load static %}

{% block title %}Detail Venue - Lapangin{% endblock %}

{% block content %}
{% include "navbar.html" %}

<div class="text-gray-800 pt-28"> {# Menyesuaikan padding atas #}
    <div class="max-w-7xl mx-auto px-4 lg:px-6 py-4"> {# Padding responsif #}
        <a href="{% url 'venue:search_venue' %}" class="flex items-center gap-2 px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 w-fit"> {# Tambah w-fit #}
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M15 18L9 12L15 6" stroke="#737373" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            <span>Kembali</span>
        </a>
    </div>

    <div class="max-w-7xl mx-auto px-4 lg:px-6 pb-8"> {# Padding responsif #}
        <div id="heroImageContainer" class="w-full h-64 sm:h-80 lg:h-96 rounded-2xl overflow-hidden bg-gray-200 "> {# Tinggi responsif #}
            <img src="{% static 'img/placeholder.png' %}" alt="Loading Stadion Image..." class="w-full h-full object-cover" id="heroImage">
        </div>
    </div>

    <div class="max-w-7xl mx-auto px-4 lg:px-6 pb-12">
        <div class="flex flex-col lg:grid lg:grid-cols-3 gap-8">
            
            <div class="lg:col-span-2 order-2 lg:order-none"> {# Urutan 2 di mobile, reset di lg #}
                <div class="mb-8" id="venueInfo">
                    <h1 class="text-3xl md:text-4xl font-bold text-gray-900 mb-3" id="stadiumName">[Nama Stadion]</h1> {# Font responsif #}
                    <div class="flex flex-col sm:flex-row items-start sm:items-center gap-4"> {# flex-col di mobile kecil #}
                        <div class="flex items-center gap-1">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M12 2L15.09 8.26L22 9.27L17.73 14.09L18.73 21L12 17.27L5.27 21L6.27 14.09L2 9.27L8.91 8.26L12 2Z" fill="#FFCC00"/>
                            </svg>
                            <span class="font-semibold text-gray-900" id="rating">-.--</span>
                        </div>
                        <div class="flex items-center gap-1 text-gray-600" id="location">
                            <svg width="21" height="26" viewBox="0 0 21 26" fill="none" xmlns="http://www.w3.org/2000/svg" class="flex-shrink-0"> {# Tambah flex-shrink-0 #}
                                <path d="M20 10.6001C20 16.5918 13.4224 22.8319 11.2137 24.7591C11.0079 24.9155 10.7574 25 10.5 25C10.2426 25 9.99208 24.9155 9.78631 24.7591C7.57756 22.8319 1 16.5918 1 10.6001C1 8.05401 2.00089 5.61218 3.78249 3.81181C5.56408 2.01144 7.98044 1 10.5 1C13.0196 1 15.4359 2.01144 17.2175 3.81181C18.9991 5.61218 20 8.05401 20 10.6001Z" stroke="#737373" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                <path d="M10.5 14.2002C12.4675 14.2002 14.0625 12.5884 14.0625 10.6001C14.0625 8.61187 12.4675 7.00007 10.5 7.00007C8.53249 7.00007 6.9375 8.61187 6.9375 10.6001C6.9375 12.5884 8.53249 14.2002 10.5 14.2002Z" stroke="#737373" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                            <span id="cityCountry">[Kota], [Negara]</span>
                        </div>
                    </div>
                </div>

                <div class="mb-8">
                    <h2 class="text-xl font-bold text-gray-900 mb-3">Deskripsi Stadion</h2>
                    <p class="text-gray-700 leading-relaxed" id="description">Loading...</p>
                </div>

                <div class="mb-8">
                    <h2 class="text-xl font-bold text-gray-900 mb-4">Cek Ketersediaan</h2>
                    <div class="flex items-center gap-3 overflow-x-auto pb-2" id="availability">
                        <p class="text-gray-500">Fitur ketersediaan belum diimplementasikan.</p>
                    </div>
                </div>

                <div class="mb-8">
                    <div class="flex flex-col sm:flex-row justify-between sm:items-center mb-4 gap-4"> {# flex-col di mobile #}
                        <h2 class="text-xl font-bold text-gray-900">Ulasan</h2>
                        {% if user.is_authenticated %}
                        <button id="open-review-modal-btn" class="bg-blue-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-600 transition w-full sm:w-auto"> {# w-full di mobile #}
                            Berikan Ulasan
                        </button>
                        {% endif %}
                    </div>
                    <div class="space-y-4" id="reviews">
                        <p class="text-gray-500">Memuat ulasan...</p>
                    </div>
                </div>
            </div>

            <div class="lg:col-span-1 w-full order-1 lg:order-none lg:sticky lg:top-28 self-start"> {# Urutan 1 di mobile, sticky di lg #}
                <div class="bg-white border border-gray-200 rounded-xl p-6">
                    <div class="mb-6" id="priceSection">
                        <p class="text-gray-600 text-sm mb-2">Mulai dari</p>
                        <h3 class="text-3xl font-bold text-blue-500 mb-4" id="price">Rp -.---</h3>
                        <a href="#" id="rentButton" class="w-full bg-blue-500 text-white font-semibold py-3 rounded-lg hover:bg-blue-600 text-center block">Sewa</a>
                    </div>

                    <div class="mb-6 pb-6 border-b border-gray-200">
                        <h4 class="font-bold text-gray-900 mb-3">Fasilitas Venue</h4>
                        <ul class="space-y-2 text-sm text-gray-700" id="facilities">
                            <li class="text-gray-500">Memuat fasilitas...</li>
                            <li class="flex gap-2"><span>•</span><span>AC Arena terpasang (12 jam)</span></li>
                            <li class="flex gap-2"><span>•</span><span>Ruang Sekretariat</span></li>
                            
                        </ul>
                    </div>

                    <div>
                        <h4 class="font-bold text-gray-900 mb-3">Aturan Venue</h4>
                        <ul class="space-y-2 text-sm text-gray-700" id="rules">
                            <li class="text-gray-500">Memuat aturan...</li>
                            <li class="flex gap-2"><span>•</span><span>No Refund</span></li>
                            <li class="flex gap-2"><span>•</span><span>No Reschedule</span></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="review-modal" class="fixed inset-0 z-40 hidden overflow-y-auto">
        <div id="modal-overlay" class="fixed inset-0 z-40 bg-black bg-opacity-50"></div>
        <div class="relative z-50 flex items-center justify-center min-h-screen p-4">
            <div class="w-full max-w-lg p-6 bg-white rounded-lg shadow-xl">
                <div class="flex items-center justify-between">
                    <h3 class="text-2xl font-semibold text-gray-800">Berikan Ulasanmu</h3>
                    <button id="close-review-modal-btn" class="text-gray-400 transition hover:text-gray-600">
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
                <form method="POST" id="review-form" action="{% url 'review:add_review' %}" class="">
                    {% csrf_token %}
                    <input type="hidden" name="venue_id" value="{{ venue_id }}">
                    <div class="flex flex-col mb-4">
                        <div class="flex flex-row-reverse justify-end rating-group">
                            <input type="radio" id="rating-5" name="rating" value="5" class="peer hidden" required>
                            <label for="rating-5" class="star-label">★</label>
                            
                            <input type="radio" id="rating-4" name="rating" value="4" class="peer hidden">
                            <label for="rating-4" class="star-label">★</label>
                            
                            <input type="radio" id="rating-3" name="rating" value="3" class="peer hidden">
                            <label for="rating-3" class="star-label">★</label>
                            
                            <input type="radio" id="rating-2" name="rating" value="2" class="peer hidden">
                            <label for="rating-2" class="star-label">★</label>
                            
                            <input type="radio" id="rating-1" name="rating" value="1" class="peer hidden">
                            <label for="rating-1" class="star-label">★</label>
                        </div>
                    </div>
                    <div class="">
                        <label for="comment" class="block text-sm font-medium text-[#737373]">Tulisan Ulasan</label>
                        <textarea id="comment" name="comment" rows="4" placeholder="Tulis disini..."
                            class="w-full px-3 py-2 mt-1 text-gray-900 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 min-h-[200px]"></textarea>
                    </div>
                    <div class="flex justify-end mt-6 space-x-3">
                        <button id="cancel-review-btn" type="button" class="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md shadow-sm hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-400"> Batal </button>
                        <button type="submit" class="px-4 py-2 text-sm font-medium text-white bg-[#0062FF] border border-transparent rounded-md shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"> Kirim Review </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div id="edit-review-modal" class="fixed inset-0 z-40 hidden overflow-y-auto">
        <div id="edit-modal-overlay" class="fixed inset-0 z-40 bg-black bg-opacity-50"></div>
        <div class="relative z-50 flex items-center justify-center min-h-screen p-4">
            <div class="w-full max-w-lg p-6 bg-white rounded-lg shadow-xl">
                <div class="flex items-center justify-between">
                    <h3 class="text-2xl font-semibold text-gray-800">Edit Ulasanmu</h3> 
                    <button id="close-edit-review-modal-btn" class="text-gray-400 transition hover:text-gray-600">
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
    
                <div id="editReviewFormMessages" class="my-4 text-sm text-red-600"></div>
    
                <form method="POST" id="edit-review-form" action="" class="">
                    {% csrf_token %}
                    <div class="flex flex-row-reverse justify-end rating-group edit-rating-group">
                        <input type="radio" id="edit-rating-5" name="rating" value="5" class="peer hidden" required>
                        <label for="edit-rating-5" class="star-label">★</label>
                        
                        <input type="radio" id="edit-rating-4" name="rating" value="4" class="peer hidden">
                        <label for="edit-rating-4" class="star-label">★</label>
                        
                        <input type="radio" id="edit-rating-3" name="rating" value="3" class="peer hidden">
                        <label for="edit-rating-3" class="star-label">★</label>
                        
                        <input type="radio" id="edit-rating-2" name="rating" value="2" class="peer hidden">
                        <label for="edit-rating-2" class="star-label">★</label>
                        
                        <input type="radio" id="edit-rating-1" name="rating" value="1" class="peer hidden">
                        <label for="edit-rating-1" class="star-label">★</label>
                    </div>
    
                    <div class="">
                        <label for="edit-comment" class="block text-sm font-medium text-[#737373]">Tulisan Ulasan</label>
                        <textarea id="edit-comment" name="comment" rows="4" placeholder="Tulis disini..."
                            class="w-full px-3 py-2 mt-1 text-gray-900 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 min-h-[200px]"></textarea>
                    </div>
    
                    <div class="flex justify-end mt-6 space-x-3">
                        <button id="cancel-edit-review-btn" type="button" class="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md shadow-sm hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-400"> Batal </button>
                        <button type="submit" class="px-4 py-2 text-sm font-medium text-white bg-[#0062FF] border border-transparent rounded-md shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"> Simpan Perubahan </button> 
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div id="deleteReviewModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center z-50 hidden p-4"> {# Tambah p-4 #}
        <div class="relative bg-white w-full max-w-lg mx-auto rounded-lg shadow-xl border border-gray-200">
            <div class="p-6 sm:p-8">
                <div class="flex justify-between items-center mb-4 pb-4 border-b">
                    <h1 class="text-2xl font-bold text-red-700">Konfirmasi Hapus Ulasan</h1>
                    <button id="closeDeleteReviewModalBtn" class="text-gray-400 hover:text-gray-600">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                    </button>
                </div>
    
                <div id="deleteReviewFormMessages" class="mb-4"></div>
    
                <p class="text-gray-700 mb-6">
                    Anda yakin ingin menghapus ulasan ini?
                    <blockquote id="deleteReviewComment" class="mt-2 pl-4 border-l-4 border-gray-300 italic text-gray-600"></blockquote> 
                    Tindakan ini tidak dapat dibatalkan.
                </p>
    
                <div class="flex flex-col sm:flex-row gap-4 pt-6 border-t border-gray-200">
                    <button type="button" id="cancelDeleteReviewBtn" class="order-2 sm:order-1 flex-1 px-6 py-3 border border-gray-300 text-gray-700 rounded-md font-medium hover:bg-gray-50 transition-colors text-center">
                        Batal
                    </button>
                    <button type="button" id="confirmDeleteReviewBtn" class="order-1 sm:order-2 flex-1 bg-red-600 text-white px-6 py-3 rounded-md font-medium hover:bg-red-700 transition-colors">
                        Ya, Hapus Ulasan
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="booking-modal" class="fixed inset-0 z-40 hidden overflow-y-auto">
        <div id="booking-modal-overlay" class="fixed inset-0 z-40 bg-black bg-opacity-50"></div>
        <div class="relative z-50 flex items-center justify-center min-h-screen p-4">
            <div class="w-full max-w-md p-6 bg-white rounded-lg shadow-xl">
                <div class="flex items-center justify-between pb-4 mb-4 border-b">
                    <h3 class="text-2xl font-semibold text-gray-800">Pilih Tanggal Booking</h3>
                    <button id="close-booking-modal-btn" class="text-gray-400 transition hover:text-gray-600">
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>

                <div id="bookingFormMessages" class="my-4 text-sm text-red-600"></div>

                <div class="mb-6">
                    <label for="booking-date-picker" class="block text-sm font-medium text-gray-700 mb-2">Pilih Tanggal:</label>
                    <div class="relative mt-1">
                        <input type="text" id="booking-date-picker" placeholder="Pilih tanggal..."
                            class="w-full pl-3 pr-10 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                        <div class="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none">
                            <svg class="h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                            </svg>
                        </div>
                    </div>
                </div>

                <div class="flex justify-end mt-6 space-x-3">
                    <button id="cancel-booking-btn" type="button" class="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md shadow-sm hover:bg-gray-50"> Batal </button>
                    <button id="submit-booking-btn" type="button" class="px-4 py-2 text-sm font-medium text-white bg-[#0062FF] rounded-md shadow-sm hover:bg-blue-700"> Booking Sekarang </button>
                </div>
            </div>
        </div>
    </div>

</div>

<style>
    .star-label {
        font-size: 2.5rem;
        color: #d1d5db;
        cursor: pointer;
        transition: color 0.2s;
    }

    .rating-group input:checked ~ .star-label {
        color: #f59e0b;
    }
</style>

<script>
    const venueId = "{{ venue_id }}"
    const isAdmin = `{{ is_admin|yesno:"true,false" }}`
    const venueDetailApiUrl = `{% url 'venue:get_venue_detail_api' venue_id=0 %}`.replace('0', venueId);
    const reviewsApiUrl = `{% url 'review:get_venue_reviews' venue_id=0 %}`.replace('0', venueId);
    const addReviewApiUrl = `{% url 'review:add_review' %}`;

    const stadiumNameEl = document.getElementById('stadiumName');
    const ratingEl = document.getElementById('rating');
    const cityCountryEl = document.getElementById('cityCountry');
    const descriptionEl = document.getElementById('description');
    const priceEl = document.getElementById('price');
    const heroImageEl = document.getElementById('heroImage');
    const reviewsContainer = document.getElementById('reviews');
    const facilitiesEl = document.getElementById('facilities');
    const rulesEl = document.getElementById('rules');

    async function fetchVenueDetails() {
        try {
            const response = await fetch(venueDetailApiUrl);
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            const result = await response.json();


            if (result.success) {
                const venue = result.venue;

                stadiumNameEl.textContent = venue.stadium;
                ratingEl.textContent =  venue.rating != null ? venue.rating : '-.--';
                cityCountryEl.textContent = `${venue.city}, ${venue.country}`;
                descriptionEl.textContent = venue.description;
                let priceNumber = parseFloat(venue.price);
                const price = priceNumber.toLocaleString('id-ID', { minimumFractionDigits: 0 });
                priceEl.innerHTML = `
                    <div class="flex items-baseline gap-2">
                        <span>Rp ${price}</span>
                        <span class="text-lg font-medium text-gray-600">/ hari</span>
                    </div>
                `;
                heroImageEl.src = venue.thumbnail;
                heroImageEl.alt = venue.stadium;

                loadVenueReviews();

            } else {
                throw new Error(result.message || 'Gagal memuat detail venue.');
            }
        } catch (error) {
            console.error('Error fetching venue details:', error);

            if (stadiumNameEl) stadiumNameEl.textContent = "Error";
            if (descriptionEl) descriptionEl.textContent = "Gagal memuat detail venue.";
            if (reviewsContainer) reviewsContainer.innerHTML = '<p class="text-red-500">Gagal memuat detail, tidak bisa memuat ulasan.</p>';
        }
    }

    const reviewModal = document.getElementById('review-modal');
    const openReviewModalBtn = document.getElementById('open-review-modal-btn');
    const closeReviewModalBtn = document.getElementById('close-review-modal-btn');
    const cancelReviewBtn = document.getElementById('cancel-review-btn');
    const reviewForm = document.getElementById('review-form');
    const modalOverlay = document.getElementById('modal-overlay');

    function openReviewModal() {
        if (reviewModal) reviewModal.classList.remove('hidden');
    }

    function closeReviewModal() {
        if (reviewModal) {
            reviewModal.classList.add('hidden');
            if (reviewForm) reviewForm.reset();
        }
    }

    async function addReviewEntry() {
        if (!reviewForm) return;
        const formData = new FormData(reviewForm);
        const csrftokenInput = reviewForm.querySelector('[name=csrfmiddlewaretoken]');
        
        if (!csrftokenInput) {
            console.error('CSRF token not found in review form!');
            alert("Error: Missing security token.");
            return;
        }
        const csrftoken = csrftokenInput.value;

        try {
            const response = await fetch(addReviewApiUrl, {
                method: "POST",
                body: formData,
                headers: { 'X-CSRFToken': csrftoken }
            });

            closeReviewModal();

            if (response.ok) {
                showToast("Review added successfully!", "", "success");
                fetchVenueDetails()
                loadVenueReviews();
            } else {
                const errorData = await response.json();
                console.error("Review submission failed:", errorData);
                showToast(`Gagal menambahkan review: ${errorData.message || 'Silakan coba lagi.'}`);
            }
        } catch (error) {
            console.error("Error submitting review:", error);
            alert("Terjadi kesalahan jaringan saat mengirim review.");
        }
    }

    if (openReviewModalBtn) openReviewModalBtn.addEventListener('click', openReviewModal);
    if (closeReviewModalBtn) closeReviewModalBtn.addEventListener('click', closeReviewModal);
    if (cancelReviewBtn) cancelReviewBtn.addEventListener('click', closeReviewModal);
    if (modalOverlay) modalOverlay.addEventListener('click', closeReviewModal);
    if (reviewForm) {
        reviewForm.addEventListener('submit', (e) => {
            e.preventDefault();
            addReviewEntry();
        });
    }

    function generateStars(rating) {
        let starsHtml = '';
        const totalStars = 5;
        for (let i = 1; i <= totalStars; i++) {
            if (i <= rating) {
                starsHtml += `<svg class="w-5 h-5 text-yellow-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10.868 2.884c.321-.772 1.305-.772 1.626 0l1.83 4.426 4.846.398c.84.069 1.18.976.544 1.53l-3.626 3.19.956 4.75c.16.793-.728 1.4-1.442.99l-4.26-2.58-4.26 2.58c-.713.41-1.602-.197-1.442-.99l.956-4.75-3.626-3.19c-.636-.554-.296-1.461.544-1.53l4.846-.398 1.83-4.426z" clip-rule="evenodd" /></svg>`;
            } else {
                starsHtml += `<svg class="w-5 h-5 text-gray-300" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M11.48 3.499a.562.562 0 0 1 1.04 0l2.125 5.111a.563.563 0 0 0 .475.31h5.518a.562.562 0 0 1 .31.95l-4.204 3.602a.563.563 0 0 0-.182.557l1.285 5.385a.562.562 0 0 1-.84.61l-4.725-3.152a.563.563 0 0 0-.652 0l-4.725 3.152a.562.562 0 0 1-.84-.61l1.285-5.385a.563.563 0 0 0-.182-.557l-4.204-3.602a.562.562 0 0 1 .31-.95h5.518a.563.563 0 0 0 .475-.31L11.48 3.5Z" /></svg>`;
            }
        }
        return starsHtml;
    }

    async function loadVenueReviews() {
        if (!reviewsContainer) return;
        reviewsContainer.innerHTML = '<p class="text-gray-500">Memuat ulasan...</p>';

        try {
            const response = await fetch(reviewsApiUrl);
            if (!response.ok) throw new Error('Gagal memuat review.');
            
            const data = await response.json();
            const reviews = data.reviews;
            const currentUserId = data.current_user_id;

            reviewsContainer.innerHTML = '';

            if (reviews.length === 0) {
                reviewsContainer.innerHTML = '<p class="text-gray-500">Belum ada ulasan untuk venue ini.</p>';
                return;
            }

            reviews.forEach(review => {
                const card = document.createElement('div');
                card.className = "w-full bg-white rounded-xl shadow-md overflow-hidden font-sans border border-gray-200 mb-4";
                const reviewStars = generateStars(review.rating);
                let editDeleteButtons = '';
                if (review.user_id === currentUserId || isAdmin) {
                    editDeleteButtons = `
                        <div class="mt-3 pt-3 border-t border-gray-100 text-sm">
                            <button data-review-id="${review.id}" class="edit-review-btn text-blue-600 hover:underline mr-3">
                                Edit
                            </button>
                            <button data-review-id="${review.id}" class="delete-review-btn text-red-600 hover:underline"">
                                Delete
                            </button>
                        </div>
                    `;
                }

                card.innerHTML = `
                    <div class="p-6">
                        <div class="flex items-center space-x-4">
                            <div class="flex-shrink-0"> <div class="h-14 w-14 rounded-full bg-gray-300 flex items-center justify-center text-gray-500"> <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1"> <path stroke-linecap="round" stroke-linejoin="round" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" /> </svg> </div> </div>
                            <div> <h3 class="font-semibold">${review.user_name}</h3> <div class="flex items-center"> ${reviewStars} </div> </div>
                        </div>
                        <div class="mt-4"> <p class="text-base"> ${review.comment || '<i>Tidak ada komentar.</i>'} </p> </div>
                        ${editDeleteButtons}
                    </div>
                `;
                reviewsContainer.appendChild(card);
            });

        } catch (error) {
            console.error('Error memuat reviews:', error);
            reviewsContainer.innerHTML = '<p class="text-red-500">Gagal memuat ulasan.</p>';
        }
    }

        document.addEventListener('DOMContentLoaded', fetchVenueDetails);

    const editReviewModal = document.getElementById('edit-review-modal');
    const closeEditReviewModalBtn = document.getElementById('close-edit-review-modal-btn');
    const cancelEditReviewBtn = document.getElementById('cancel-edit-review-btn');
    const editReviewForm = document.getElementById('edit-review-form');
    const editReviewFormMessages = document.getElementById('editReviewFormMessages');
    const editModalOverlay = document.getElementById('edit-modal-overlay');

    const deleteReviewModal = document.getElementById('deleteReviewModal');
    const closeDeleteReviewModalBtn = document.getElementById('closeDeleteReviewModalBtn');
    const cancelDeleteReviewBtn = document.getElementById('cancelDeleteReviewBtn');
    const confirmDeleteReviewBtn = document.getElementById('confirmDeleteReviewBtn');
    const deleteReviewCommentEl = document.getElementById('deleteReviewComment');
    const deleteReviewFormMessages = document.getElementById('deleteReviewFormMessages');

    async function openEditReviewModal(reviewId) {
        editReviewFormMessages.textContent = '';
        const apiUrl = `{% url 'review:edit_review' review_id=0 %}`.replace('0', reviewId);

        if (!isAuth) {
            window.location.href = '/accounts/login/';
            return;
        }

        try {
            const response = await fetch(apiUrl);
            if (!response.ok) throw new Error('Gagal mengambil data review.');
            
            const result = await response.json();
            if (!result.success) throw new Error(result.message || 'Data review tidak ditemukan.');
            
            const data = result.data;

            const ratingInputs = editReviewForm.querySelectorAll('input[name="rating"]');
            ratingInputs.forEach(input => {
                input.checked = (parseInt(input.value) === Math.round(data.rating)); // Match integer part
            });

            editReviewForm.elements.comment.value = data.comment || '';
            editReviewForm.action = apiUrl;
            editReviewModal.classList.remove('hidden');

        } catch (error) {
            console.error('Error opening edit review modal:', error);
            alert('Gagal memuat data edit review: ' + error.message);
        }
    }

    function closeEditReviewModal() {
        editReviewModal.classList.add('hidden');
        editReviewForm.reset();
        editReviewFormMessages.textContent = '';
    }

    function openDeleteReviewModal(reviewId, comment) {
        deleteReviewFormMessages.textContent = '';
        const apiUrl = `{% url 'review:delete_review' review_id=0 %}`.replace('0', reviewId);
        
        const commentText = (typeof comment === 'string') ? comment : '';
        
        confirmDeleteReviewBtn.dataset.apiUrl = apiUrl;
        
        deleteReviewModal.classList.remove('hidden');
    }

    function closeDeleteReviewModal() {
        deleteReviewModal.classList.add('hidden');
        confirmDeleteReviewBtn.dataset.apiUrl = '';
        deleteReviewCommentEl.textContent = '';
        deleteReviewFormMessages.textContent = '';
    }


    if (closeEditReviewModalBtn) closeEditReviewModalBtn.addEventListener('click', closeEditReviewModal);
    if (cancelEditReviewBtn) cancelEditReviewBtn.addEventListener('click', closeEditReviewModal);
    if (editModalOverlay) editModalOverlay.addEventListener('click', closeEditReviewModal);
    if (editReviewForm) {
        editReviewForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            editReviewFormMessages.textContent = '';
            const formData = new FormData(editReviewForm);
            const csrftokenInput = editReviewForm.querySelector('[name=csrfmiddlewaretoken]');
            if (!csrftokenInput) return;

            try {
                const response = await fetch(editReviewForm.action, {
                    method: 'POST',
                    body: formData,
                    headers: { 'X-CSRFToken': csrftokenInput.value }
                });
                
                const result = await response.json();

                if (response.ok) {
                    closeEditReviewModal();
                    showToast(result.message || "Review diperbarui!", "", "success");
                    loadVenueReviews();
                    fetchVenueDetails();
                } else {
                    if (result.errors) {
                        const errors = JSON.parse(result.errors);
                        let errorMsg = "Periksa input Anda:\n";
                        for (const field in errors) {
                            errors[field].forEach(err => errorMsg += `- ${field}: ${err.message}\n`);
                        }
                        editReviewFormMessages.textContent = errorMsg.trim();
                    } else {
                        editReviewFormMessages.textContent = result.message || 'Gagal menyimpan perubahan.';
                    }
                }
            } catch (error) {
                console.error("Error submitting edit review form:", error);
                editReviewFormMessages.textContent = "Terjadi kesalahan jaringan.";
            }
        });
    }


    if (closeDeleteReviewModalBtn) closeDeleteReviewModalBtn.addEventListener('click', closeDeleteReviewModal);
    if (cancelDeleteReviewBtn) cancelDeleteReviewBtn.addEventListener('click', closeDeleteReviewModal);

    if (confirmDeleteReviewBtn) {
        confirmDeleteReviewBtn.addEventListener('click', async () => {
            const apiUrl = confirmDeleteReviewBtn.dataset.apiUrl;
            if (!apiUrl) return;
            
            const csrftoken = document.querySelector('#edit-review-form [name=csrfmiddlewaretoken]')?.value ||
                            document.querySelector('#review-form [name=csrfmiddlewaretoken]')?.value;
            if (!csrftoken) {
                alert('Error: Missing security token for delete.');
                return;
            }

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'X-CSRFToken': csrftoken }
                });

                const result = await response.json();

                if (response.ok && result.status === 'success') {
                    closeDeleteReviewModal();
                    showToast(result.message || "Review dihapus!", "", "success");
                    loadVenueReviews();
                    fetchVenueDetails();
                } else {
                    deleteReviewFormMessages.textContent = result.message || 'Gagal menghapus review.';
                }
            } catch (error) {
                console.error("Error deleting review:", error);
                deleteReviewFormMessages.textContent = "Terjadi kesalahan jaringan.";
            }
        });
    }


    reviewsContainer.addEventListener('click', (event) => {
        const editButton = event.target.closest('.edit-review-btn');
        const deleteButton = event.target.closest('.delete-review-btn');

        if (editButton) {
            event.preventDefault();
            const reviewId = editButton.dataset.reviewId;
            if (reviewId) {
                openEditReviewModal(reviewId);
            }
        } else if (deleteButton) {
            event.preventDefault();
            const reviewId = deleteButton.dataset.reviewId;
            const comment = deleteButton.dataset.comment;
            if (reviewId) {
                openDeleteReviewModal(reviewId, comment);
            }
        }
    });

    const openBookingModalBtn = document.getElementById('rentButton');
    const bookingModal = document.getElementById('booking-modal');
    const closeBookingModalBtn = document.getElementById('close-booking-modal-btn');
    const cancelBookingBtn = document.getElementById('cancel-booking-btn');
    const submitBookingBtn = document.getElementById('submit-booking-btn');
    const bookingModalOverlay = document.getElementById('booking-modal-overlay');
    const datePickerInput = document.getElementById('booking-date-picker');
    const bookingFormMessages = document.getElementById('bookingFormMessages');
    const bookedDatesApiUrl = `{% url 'booking:get_booked_dates_api' venue_id=0 %}`.replace('0', venueId);
    const createBookingUrl = `{% url 'booking:create_booking_api' %}`;
    let datePickerInstance = null;

    async function openBookingModal() {
        if (!bookingModal || !datePickerInput) return;
        bookingFormMessages.textContent = '';
        if (datePickerInstance) datePickerInstance.destroy();
        datePickerInput.value = '';

        let isAuth = `{{ user.is_authenticated|lower }}`;
        if (isAuth == "false") {
            window.location.href = '/accounts/login'
            return
        }

        try {
            const response = await fetch(bookedDatesApiUrl);
            if (!response.ok) throw new Error('Gagal memuat tanggal booking.');
            const data = await response.json();

            
            datePickerInstance = flatpickr(datePickerInput, {
                mode: "single",
                minDate: "today",
                dateFormat: "Y-m-d",
                disable: data.booked_dates || [],
                locale: "id",
                onChange: () => bookingFormMessages.textContent = ''
            });
            bookingModal.classList.remove('hidden');
        } catch (error) {
            console.error("Error opening booking modal:", error);
            alert("Gagal membuka form booking: " + error.message);
        }
    }

    function closeBookingModal() {
        if (bookingModal) bookingModal.classList.add('hidden');
        if (datePickerInstance) {
            datePickerInstance.destroy();
            datePickerInstance = null;
        }
        bookingFormMessages.textContent = '';
    }

    async function submitBooking() {
        if (!datePickerInstance || datePickerInstance.selectedDates.length === 0) {
            bookingFormMessages.textContent = 'Silakan pilih tanggal booking.';
            return;
        }

        const selectedDate = datePickerInstance.selectedDates[0];
        const formattedDate = flatpickr.formatDate(selectedDate, "Y-m-d");

        const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]')?.value;
        if (!csrftoken) { return; }

        bookingFormMessages.textContent = 'Memproses booking...';

        try {
            const response = await fetch(createBookingUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrftoken },
                body: JSON.stringify({
                    venue_id: venueId,
                    booking_date: formattedDate
                })
            });
            const result = await response.json();

            if (response.ok && result.success) {
                closeBookingModal();
                showToast(result.message || "Booking berhasil!", "", "success");
            } else {
                bookingFormMessages.textContent = result.message || 'Gagal membuat booking.';
            }
        } catch (error) { /* ... (handle fetch error) ... */ }
    }

    // Venue Detail Load
    document.addEventListener('DOMContentLoaded', fetchVenueDetails);
    
    if (openBookingModalBtn) openBookingModalBtn.addEventListener('click', (e) => {e.preventDefault(); openBookingModal()});
    if (closeBookingModalBtn) closeBookingModalBtn.addEventListener('click', closeBookingModal);
    if (cancelBookingBtn) cancelBookingBtn.addEventListener('click', closeBookingModal);
    if (bookingModalOverlay) bookingModalOverlay.addEventListener('click', closeBookingModal);
    if (submitBookingBtn) submitBookingBtn.addEventListener('click', submitBooking);

</script>

{% endblock content %}