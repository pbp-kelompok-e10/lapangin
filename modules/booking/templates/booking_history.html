{% extends "base.html" %}
{% load static %}

{% block title %}Riwayat Booking - Lapangin{% endblock %}

{% block content %}
{% include "navbar.html" %}

<div class=" text-gray-800 min-h-screen">
    <div class="max-w-5xl mx-auto px-4 sm:px-6 lg:px-8 pb-12 mt-[100px] md:mt-40">
        <h1 class="text-3xl sm:text-4xl font-bold text-gray-900 mb-8 md:mb-12">Riwayat Booking Anda</h1>
        <div id="booking-history-container" class="space-y-6">
            <!-- Loading skeleton - akan diganti saat data dimuat -->
            <div class="loading-skeleton bg-white border border-gray-300 rounded-lg shadow-sm overflow-hidden flex flex-col sm:flex-row animate-pulse">
                <div class="w-full sm:w-1/3 h-48 sm:h-auto flex-shrink-0 bg-gray-200"></div>
                <div class="p-4 sm:p-6 flex-grow flex flex-col justify-between">
                    <div>
                        <div class="h-6 bg-gray-200 rounded w-3/4 mb-2"></div>
                        <div class="h-4 bg-gray-200 rounded w-1/2 mb-3"></div>
                        <div class="h-4 bg-gray-200 rounded w-2/3"></div>
                    </div>
                    <div class="mt-4 flex justify-between items-center">
                        <div class="h-5 bg-gray-200 rounded w-20"></div>
                        <div class="flex items-center gap-2">
                            <div class="h-4 bg-gray-200 rounded w-16"></div>
                            <div class="h-4 bg-gray-200 rounded w-20"></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="loading-skeleton bg-white border border-gray-300 rounded-lg shadow-sm overflow-hidden flex flex-col sm:flex-row animate-pulse">
                <div class="w-full sm:w-1/3 h-48 sm:h-auto flex-shrink-0 bg-gray-200"></div>
                <div class="p-4 sm:p-6 flex-grow flex flex-col justify-between">
                    <div>
                        <div class="h-6 bg-gray-200 rounded w-3/4 mb-2"></div>
                        <div class="h-4 bg-gray-200 rounded w-1/2 mb-3"></div>
                        <div class="h-4 bg-gray-200 rounded w-2/3"></div>
                    </div>
                    <div class="mt-4 flex justify-between items-center">
                        <div class="h-5 bg-gray-200 rounded w-20"></div>
                        <div class="flex items-center gap-2">
                            <div class="h-4 bg-gray-200 rounded w-16"></div>
                            <div class="h-4 bg-gray-200 rounded w-20"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="edit-booking-modal" class="fixed inset-0 z-40 hidden overflow-y-auto transition-opacity duration-300 ease-in-out hidden">
        <div id="edit-booking-overlay" class="fixed inset-0 z-40 bg-black bg-opacity-50 transition-opacity duration-300 ease-in-out"></div>
        <div class="relative z-50 flex items-center justify-center min-h-screen p-4">
            <form class="w-full max-w-md p-6 bg-white rounded-lg shadow-xl transition-all duration-300 ease-out transform scale-95" id="edit-booking-form"> 
                {% csrf_token %}
                <div class="flex items-center justify-between pb-4 mb-4 border-b">
                    <h3 class="text-2xl font-semibold text-gray-800">Ubah Tanggal Booking</h3>
                    <button id="close-edit-booking-modal-btn" class="text-gray-400 transition-colors duration-200 hover:text-gray-600 rounded-full p-1 focus:outline-none focus:ring-2 focus:ring-gray-400">
                        <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"> <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /> </svg>
                    </button>
                </div>
                
                <div id="editBookingFormMessages" class="my-4 text-sm text-red-600"></div>
                
                <input type="hidden" id="edit-booking-id">
                <input type="hidden" id="edit-booking-venue-id">

                <div class="mb-6">
                    <label for="edit-booking-date-picker" class="block text-sm font-medium text-gray-700 mb-2">Pilih Tanggal Baru:</label>
                    <input type="text" id="edit-booking-date-picker" placeholder="Pilih tanggal baru..."
                        class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>
                
                <div class="flex flex-col sm:flex-row-reverse gap-3 mt-6">
                    <button id="submit-edit-booking-btn" type="button" class="w-full sm:w-auto px-4 py-2 text-sm font-medium text-white bg-[#0062FF] rounded-md shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-colors duration-200">
                        Simpan Perubahan
                    </button>
                    <button id="cancel-edit-booking-btn" type="button" class="w-full sm:w-auto px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md shadow-sm hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-gray-400 focus:ring-offset-2 transition-colors duration-200">
                        Batal
                    </button>
                </div>
            </form>
        </div>
    </div>

    <div id="deleteBookingModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center z-50 hidden transition-opacity duration-300 ease-in-out ">
        <form class="relative bg-white w-full max-w-lg mx-auto rounded-lg shadow-xl border border-gray-200 transition-all duration-300 ease-out transform scale-95"
            id="delete-booking-panel"> <div class="p-6 sm:p-8">
                {% csrf_token %}
                <div class="flex justify-between items-center mb-4 pb-4 border-b">
                    <h1 class="text-2xl font-bold text-red-700">Konfirmasi Pembatalan</h1>
                    <button id="closeDeleteBookingModalBtn" class="text-gray-400 transition-colors duration-200 hover:text-gray-600 rounded-full p-1 focus:outline-none focus:ring-2 focus:ring-gray-400">
                        <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"> <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /> </svg>
                    </button>
                </div>
                
                <div id="deleteBookingFormMessages" class="mb-4"></div>
                
                <p class="text-gray-700 mb-6">
                    Anda yakin ingin membatalkan booking untuk
                    <strong id="deleteBookingVenueName" class="font-bold text-gray-900"></strong> pada tanggal
                    <strong id="deleteBookingDate" class="font-bold text-gray-900"></strong>?
                    <br> <span class="text-sm">Tindakan ini mungkin tidak dapat dibatalkan (tergantung aturan).</span>
                </p>
                
                <div class="flex flex-col sm:flex-row gap-4 pt-6 border-t border-gray-200">
                    <button type="button" id="cancelDeleteBookingBtn" class="order-2 sm:order-1 flex-1 px-6 py-3 border border-gray-300 text-gray-700 rounded-md font-medium hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-gray-400 focus:ring-offset-2 transition-colors duration-200">
                        Tidak
                    </button>
                    <button type="button" id="confirmDeleteBookingBtn" class="order-1 sm:order-2 flex-1 bg-red-600 text-white px-6 py-3 rounded-md font-medium hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2 transition-colors duration-200">
                        Ya, Batalkan Booking
                    </button>
                </div>
            </div>
        </form>
    </div>

</div>

<script>
    const bookingHistoryApiUrl = "{% url 'booking:get_user_bookings_api' %}";
    const historyContainer = document.getElementById('booking-history-container');
    const csrftoken = document.querySelector('input[name="csrfmiddlewaretoken"]')?.value;
    const editBookingModal = document.getElementById('edit-booking-modal');
    const closeEditBookingModalBtn = document.getElementById('close-edit-booking-modal-btn');
    const cancelEditBookingBtn = document.getElementById('cancel-edit-booking-btn');
    const submitEditBookingBtn = document.getElementById('submit-edit-booking-btn');
    const editBookingModalOverlay = document.getElementById('edit-booking-overlay');
    const editDatePickerInput = document.getElementById('edit-booking-date-picker');
    const editBookingFormMessages = document.getElementById('editBookingFormMessages');
    const editBookingIdInput = document.getElementById('edit-booking-id');
    const editBookingVenueIdInput = document.getElementById('edit-booking-venue-id');
    const editBookingPanel = document.getElementById('edit-booking-panel');
    let editDatePickerInstance = null;

    const deleteBookingModal = document.getElementById('deleteBookingModal');
    const closeDeleteBookingModalBtn = document.getElementById('closeDeleteBookingModalBtn');
    const cancelDeleteBookingBtn = document.getElementById('cancelDeleteBookingBtn');
    const confirmDeleteBookingBtn = document.getElementById('confirmDeleteBookingBtn');
    const deleteBookingVenueNameEl = document.getElementById('deleteBookingVenueName');
    const deleteBookingDateEl = document.getElementById('deleteBookingDate');
    const deleteBookingFormMessages = document.getElementById('deleteBookingFormMessages');
    const deleteBookingPanel = document.getElementById('delete-booking-panel');

    function formatDateReadable(isoDateString) {
    const date = new Date(isoDateString);

    const options = {
        day: 'numeric',
        month: 'long',
        year: 'numeric'
    };

    return new Intl.DateTimeFormat('id-ID', options).format(date);
}
    async function loadBookingHistory() {
        try {
            const response = await fetch(bookingHistoryApiUrl);
            const data = await response.json();
            const bookings = data.bookings;
            historyContainer.innerHTML = '';
            if (!bookings || bookings.length === 0) {
                // Empty state
                historyContainer.innerHTML = `
                    <div class="text-center py-16">
                        <div class="mb-6">
                            <svg class="mx-auto w-24 h-24 text-gray-300" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                            </svg>
                        </div>
                        <h3 class="text-xl font-semibold text-gray-700 mb-2">Belum Ada Riwayat Booking</h3>
                        <p class="text-gray-500 mb-6 max-w-md mx-auto">Anda belum melakukan booking apapun. Mulai cari venue dan booking sekarang!</p>
                        <a href="{% url 'venue:search_venue' %}" 
                            class="inline-flex items-center gap-2 px-6 py-3 bg-[#0062FF] text-white rounded-lg font-medium hover:bg-blue-700 transition-colors">
                            <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                            </svg>
                            Cari Venue
                        </a>
                    </div>
                `;
                return;
            }

            bookings.forEach(booking => {
                const bookingCard = document.createElement('div');
                bookingCard.className = "bg-white border border-gray-300 rounded-lg shadow-sm overflow-hidden flex flex-col sm:flex-row";
                bookingCard.dataset.bookingId = booking.booking_id;

                const bookingDateFormatted = formatDateReadable(booking.booking_date);
                const today = new Date().toISOString().split('T')[0];
                let statusText = "Akan Datang"; let statusColor = "bg-blue-100 text-blue-700";
                if (booking.booking_date < today) { statusText = "Selesai"; statusColor = "bg-green-100 text-green-700"; } 
                else if (booking.booking_date === today) { statusText = "Hari Ini"; statusColor = "bg-yellow-100 text-yellow-700"; }

                let actionButtons = '';
                if (booking.can_modify) {
                    actionButtons = `
                        <button class="edit-booking-btn text-xs text-blue-600 hover:underline mr-2"
                                data-booking-id="${booking.booking_id}"
                                data-venue-id="${booking.venue_id}"
                                data-current-date="${booking.booking_date}">
                            Ubah Tanggal
                        </button>
                        <button class="delete-booking-btn text-xs text-red-600 hover:underline"
                                data-booking-id="${booking.booking_id}"
                                data-venue-name="${booking.venue_name}"
                                data-booking-date="${booking.booking_date}">
                            Batalkan
                        </button>
                    `;
                }

                const viewLink = `
                    <a href="${booking.url_detail}" class="text-sm text-blue-600 hover:underline view-venue-link ml-4" data-venue-id="${booking.venue_id}"> Lihat Venue &rarr; </a>
                `

                bookingCard.innerHTML = `
                    <div class="w-full sm:w-1/3 h-48 sm:h-auto flex-shrink-0"> <img src="${booking.venue_thumbnail}" alt="${booking.venue_name}" class="w-full h-full object-cover"> </div>
                    <div class="p-4 sm:p-6 flex-grow flex flex-col justify-between">
                        <div>
                            <h2 class="text-xl font-semibold text-gray-900 mb-1">${booking.venue_name}</h2>
                            <p class="text-gray-600 text-sm mb-3"> ID: #${booking.booking_id} &bull; Dibuat: ${formatDateReadable(booking.created_at)} </p>
                            <p class="text-gray-800 font-medium booking-date-display"> üóìÔ∏è Tanggal: ${bookingDateFormatted} </p>
                        </div>
                        <div class="mt-4 flex justify-between items-center">
                            <span class="text-xs font-medium px-2.5 py-0.5 rounded ${statusColor}"> ${statusText} </span>
                            <div class="flex items-center">
                                ${actionButtons}
                                ${viewLink}
                            </div>
                        </div>
                    </div>
                `;

                historyContainer.appendChild(bookingCard);
            });
        } catch (error) {}
    }

    async function openEditBookingModal(bookingId, venueId, currentDate) {
        if (!editBookingModal || !editDatePickerInput) return;
        editBookingFormMessages.textContent = '';
        if (editDatePickerInstance) editDatePickerInstance.destroy();
        editDatePickerInput.value = currentDate;
        editBookingIdInput.value = bookingId;
        editBookingVenueIdInput.value = venueId;

        const dummyUuid = '00000000-0000-0000-0000-000000000000';
        const bookedDatesUrl = `{% url 'booking:get_booked_dates_api' venue_id='00000000-0000-0000-0000-000000000000' %}`.replace(dummyUuid, venueId);

        try {
            const response = await fetch(bookedDatesUrl);
            if (!response.ok) throw new Error('Gagal memuat tanggal booking.');
            const data = await response.json();
            
            const disabledDates = (data.booked_dates || []).filter(d => d !== currentDate);

            editDatePickerInstance = flatpickr(editDatePickerInput, {
                mode: "single",
                minDate: "today",
                dateFormat: "Y-m-d",
                defaultDate: currentDate,
                disable: disabledDates,
                locale: "id",
                onChange: () => editBookingFormMessages.textContent = ''
            });
            editBookingModal.classList.remove('hidden');

        } catch (error) {
            console.error("Error opening edit booking modal:", error);
            alert("Gagal membuka form edit booking: " + error.message);
        }
    }

    function closeEditBookingModal() {
        editBookingModal.classList.add("hidden");
    }

    async function submitEditBooking() {
        if (!editDatePickerInstance || editDatePickerInstance.selectedDates.length === 0) {
            editBookingFormMessages.textContent = 'Silakan pilih tanggal baru.'; return;
        }
        const selectedDate = editDatePickerInstance.selectedDates[0];
        const formattedDate = flatpickr.formatDate(selectedDate, "Y-m-d");
        const bookingId = editBookingIdInput.value;
        const editUrl = `{% url 'booking:edit_booking_api' booking_id=0 %}`.replace('0', bookingId);
        
        if (!csrftoken) { return; }
        editBookingFormMessages.textContent = 'Menyimpan perubahan...';

        try {
            const response = await fetch(editUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrftoken },
                body: JSON.stringify({ booking_date: formattedDate })
            });
            const result = await response.json();
            if (response.ok) {
                closeEditBookingModal();
                showToast(result.message || "Booking diperbarui!", "", "success");
                const cardToUpdate = historyContainer.querySelector(`[data-booking-id="${bookingId}"]`);
                if (cardToUpdate) {
                    const dateDisplay = cardToUpdate.querySelector('.booking-date-display');
                    if(dateDisplay) dateDisplay.textContent = `üóìÔ∏è Tanggal: ${formatDateReadable(formattedDate)}`;
                }
                loadBookingHistory();
            } else {
                editBookingFormMessages.textContent = result.message || 'Gagal menyimpan perubahan.';
            }
        } catch (error) { }
    }


    function openDeleteBookingModal(bookingId, venueName, bookingDate) {
        if (!deleteBookingModal) return;
        deleteBookingFormMessages.textContent = '';
        const deleteUrl = `{% url 'booking:delete_booking_api' booking_id=0 %}`.replace('0', bookingId);
        
        deleteBookingVenueNameEl.textContent = venueName || '[Nama Venue]';
        deleteBookingDateEl.textContent = formatDateReadable(bookingDate) || '[Tanggal]';
        confirmDeleteBookingBtn.dataset.apiUrl = deleteUrl;
        confirmDeleteBookingBtn.dataset.bookingId = bookingId;
        
        deleteBookingModal.classList.remove('hidden');
    }

    function closeDeleteBookingModal() {
        deleteBookingModal.classList.add("hidden")
    }

    async function confirmDeleteBooking() {
        const apiUrl = confirmDeleteBookingBtn.dataset.apiUrl;
        const bookingId = confirmDeleteBookingBtn.dataset.bookingId;
        if (!apiUrl || !bookingId) { return; }
        
        deleteBookingFormMessages.textContent = 'Membatalkan booking...';

        try {
            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'X-CSRFToken': csrftoken }
            });
            const result = await response.json();
            if (response.ok) {
                closeDeleteBookingModal();
                showToast(result.message || "Booking dibatalkan!", "", "success");
                const cardToRemove = historyContainer.querySelector(`[data-booking-id="${bookingId}"]`);
                if (cardToRemove) cardToRemove.remove();
                if (historyContainer.children.length === 0) {
                    historyContainer.innerHTML = '<p class="text-gray-500">Anda belum memiliki riwayat booking.</p>';
                }
            } else {
                deleteBookingFormMessages.textContent = result.message || 'Gagal membatalkan booking.';
            }

        } catch (error) {
            deleteBookingFormMessages.textContent = 'Error koneksi. Coba lagi.';
            console.error("Delete booking error:", error);
        }
    }


    document.addEventListener('DOMContentLoaded', loadBookingHistory);

    if(closeEditBookingModalBtn) closeEditBookingModalBtn.addEventListener('click', closeEditBookingModal);
    if(cancelEditBookingBtn) cancelEditBookingBtn.addEventListener('click', closeEditBookingModal);
    if(editBookingModalOverlay) editBookingModalOverlay.addEventListener('click', closeEditBookingModal);
    if(submitEditBookingBtn) submitEditBookingBtn.addEventListener('click', submitEditBooking);

    if(closeDeleteBookingModalBtn) closeDeleteBookingModalBtn.addEventListener('click', closeDeleteBookingModal);
    if(cancelDeleteBookingBtn) cancelDeleteBookingBtn.addEventListener('click', closeDeleteBookingModal);
    if(confirmDeleteBookingBtn) confirmDeleteBookingBtn.addEventListener('click', confirmDeleteBooking);

    historyContainer.addEventListener('click', (event) => {
        const editButton = event.target.closest('.edit-booking-btn');
        const deleteButton = event.target.closest('.delete-booking-btn');

        if (editButton) {
            event.preventDefault();
            const bookingId = editButton.dataset.bookingId;
            const venueId = editButton.dataset.venueId;
            const currentDate = editButton.dataset.currentDate;
            if (bookingId && venueId && currentDate) {
                openEditBookingModal(bookingId, venueId, currentDate);
            }
        } else if (deleteButton) {
            event.preventDefault();
            const bookingId = deleteButton.dataset.bookingId;
            const venueName = deleteButton.dataset.venueName;
            const bookingDate = deleteButton.dataset.bookingDate;
            if (bookingId && venueName && bookingDate) {
                openDeleteBookingModal(bookingId, venueName, bookingDate);
            }
        }
    });

</script>

{% endblock content %}